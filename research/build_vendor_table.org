#+TITLE: Build_vendor_table
Goal is to combine ip-asn data from 3 sources
- peeringdb
- shadowserver.org
- pyasn
* Desired ouput
- ASN
- Company name
- subnet
- start_ip
- end_ip
- start_ip_int
- end_ip_int
* Get asn to company list
I found quite a few, but the most complete list at this time is:
https://bgp.potaroo.net/cidr/autnums.html
#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME"))
mkdir autonums
cd autonums
wget https://bgp.potaroo.net/cidr/autnums.html
#+END_SRC
#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
cat autnums.html
#+END_SRC
** Suggestion from zz is to use the beautiful soup library from python
I am going to work through https://zetcode.com/python/beautifulsoup/#:~:text=BeautifulSoup%20is%20a%20Python%20library,%2C%20navigable%20string%2C%20or%20comment.
I will work in the autonums dir

#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
sudo pip3 install lxml
#+END_SRC
#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
sudo pip3 install bs4
#+END_SRC
#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
cat autnums.html | head
#+END_SRC

#+BEGIN_SRC python tmate :window python
#print('Please wait')
return 'A line of text.\n'
#+END_SRC
#+BEGIN_SRC python
return 'A line of text.\n'
#+END_SRC
#+RESULTS:
#+begin_example
/home/ii/ii/org/research
#+end_example
*** run python in-line, FAIL
Python in org is not working, something related to list
Error: if: Symbolâ€™s value as variable is void: eshell-modules-list
Skipping troubleshooting this, just going to run it as a script in tmate
#+BEGIN_SRC python :dir (concat (getenv "HOME") "/autonums") :results output
from bs4 import BeautifulSoup
print ('start')
with open('/home/ii/autonums/autnums.html', 'r') as f:
    contents = f.read()
    soup = BeautifulSoup(contents, 'lxml')
    print(soup.head)
print ('end')
#+END_SRC
Even very basic command that works in a old box fails
#+BEGIN_SRC python tmate :window python
#print('Please wait')
return 'A line of text.\n'.rstrip()
#+END_SRC

*** run python in script WORKS
You have to tangle this file out with ctrl-c, ctrl-v, t
NOTE, that command will write files for all tangle blocks in the document
If you dont want this on to write to disk again just comment it out.
#+BEGIN_SRC python :tangle (concat (getenv "HOME") "/autonums/testing_soup.py")
#!/usr/bin/python
from bs4 import BeautifulSoup
with open('/home/ii/autonums/autnums.html', 'r') as f:
    contents = f.read()
    soup = BeautifulSoup(contents, 'lxml')
        print(soup.head)
#+END_SRC
This runs the above to produce output
#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
chmod +x testing_soup.py
python testing_soup.py
#+END_SRC
** Build the script
#+BEGIN_SRC python :tangle (concat (getenv "HOME") "/autonums/soup.py")
#!/usr/bin/python
from bs4 import BeautifulSoup
with open('/home/ii/autonums/autnums.html', 'r') as input_file:
    contents = input_file.read()
    soup = BeautifulSoup(contents, 'lxml')
#    printn(soup.a)
for tag in soup.find_all('a'):
    asn = (f'"{tag.text}, {tag.next_sibling}"')
    # print(asn)
    results_file = open("asn_company_results.csv", "a")
    results_file.write(asn)
    results_file.write("\n")
   # print >>results_file, asn
    results_file.close()
input_file.close()
#+END_SRC
This ggruns the above to produce output
    #+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
chmod +x soup.py
python soup.py
#+END_SRC
Litle cleanup of the output
ok this is GROSSS! I know I know, dont judge me
Obviously I just dealt with each import failure one at a time till it worked
Stephen is taking a look to see if he can clean some of this up to be a bit more elegant
Thank you Stephen!!
#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
sed -i 's/,//2' asn_company_results.csv
sed -i 's/,//2' asn_company_results.csv
sed -i 's/,//2' asn_company_results.csv
sed -i 's/,//2' asn_company_results.csv
sed -i 's/,//2' asn_company_results.csv
sed -i 's/,//2' asn_company_results.csv
sed -i 's/,//2' asn_company_results.csv
sed -i 's/\.,//' asn_company_results.csv
sed -i 's/\s\+,/\,/' asn_company_results.csv
sed -i 's/,\s\+/,\"/' asn_company_results.csv
sed -i 's/,/\",/' asn_company_results.csv
sed -i 's/CT-CNGI China telecom AC\/AEUR.*/CT-CNGI China telecom AC\/AEURA/g' asn_company_results.csv
sed -i 's/IRKUT_IAP-AS.*/IRKUT_IAP-AS/g' asn_company_results.csv
sed -i '/^\"$/d' asn_company_results.csv
sed -i 's/$/\"/' asn_company_results.csv
#+END_SRC
** Import to postgres
I stand up a postgres instance in the peeringdb section
If you need one go look in peeringdb to see the command to start one.
#+BEGIN_SRC sql-mode
-- adding this table to match wat caleb used
-- create table asnproc (asn varchar, name varchar);
-- \COPY asnproc from '/home/ii/autonums/asn_company_results.csv' DELIMITER ',' CSV;
create table company_asn  (asn varchar, name varchar);
\COPY company_asn from '/home/ii/autonums/asn_company_results.csv' DELIMITER ',' CSV;
#+END_SRC

#+RESULTS:
#+begin_SRC example
#+end_SRC
#+BEGIN_SRC sql-mode
--select * from company_asn limit 10;
select * from asnproc limit 10;
#+END_SRC

#+RESULTS:
#+begin_SRC example
#+end_SRC

* Peeringdb - skipping open fold to see logic
tldr; peeringdb only has 22 500 asn's we have 2 other sources with way more.
I will rather use peeringdb to get asn metadata until we get access to arin and other registrars
I found a very cool new way to look at the peeringdb data
[https://www.peeringdb.com/api/](https://www.peeringdb.com/api/)
Looks like direct access to the data on ix, ixlan, net, netfac, and org
sadly it does confirm that we only have 22 320 records
 `curl -sG https://www.peeringdb.com/api/net --data-urlencode fields=id | jq '.data | length`'
22320
** Parse from peeringdb using Postgres

Bring up Postgres
#+BEGIN_SRC tmate :window postgres
docker run -it --rm -p 5432:5432 -e POSTGRES_PASSWORD=password -e POSTGRES_DB=peeringdb postgres:12.2-alpine
#+END_SRC

Clone https://git.2e8.dk/peeringdb-simplesync
#+BEGIN_SRC tmate :window prepare :dir (getenv "HOME")
git clone https://git.2e8.dk/peeringdb-simplesync
cd peeringdb-simplesync
#+END_SRC

Set psql creds
#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
export \
    PGUSER=postgres \
    PGPASSWORD=password
#+END_SRC

import the schema
#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
psql -U postgres -d peeringdb -h $SHARINGIO_PAIR_LOAD_BALANCER_IP < schema.sql
#+END_SRC

Enter PeeringDB creds ( you will need valid credentials for peeringdb.com )
#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
read -p 'PEERINGDB_USER    : ' PEERINGDB_USER
#+END_SRC
#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
read -p 'PEERINGDB_PASSWORD: ' PEERINGDB_PASSWORD
#+END_SRC

#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
export PEERINGDB_USER PEERINGDB_PASSWORD
#+END_SRC

Write the config for sync.py
#+BEGIN_SRC python :tangle (concat (getenv "HOME") "/peeringdb-simplesync/config.py")
from requests.auth import HTTPBasicAuth
import os

host=os.environ['SHARINGIO_PAIR_LOAD_BALANCER_IP']
user=os.environ['PEERINGDB_USER']
password=os.environ['PEERINGDB_PASSWORD']

def get_config():
    return {
        'db_conn_str': 'dbname=peeringdb host=%s user=postgres password=password' % host,
        'db_schema': 'peeringdb',
        'auth': HTTPBasicAuth(user, password)
    }
#+END_SRC

Dump all of the data
I had to install psycopg2
#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
pip install psycopg2-binary
#+END_SRC
#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
python3 ./sync.py
#+END_SRC

** Create a new dump
After running the above Dump the database
#+BEGIN_SRC tmate :window peeringdb-sync :dir (concat (getenv "HOME") "/peeringdb-simplesync")
pg_dump -U postgres -d peeringdb -h $SHARINGIO_PAIR_LOAD_BALANCER_IP > peeringdb-dump-$(date +%Y%m%d).sql
#+END_SRC
Upload the dump
#+BEGIN_SRC tmate :window peeringdb-sync
gsutil cp peeringdb-dump-$(date +%Y%m%d).sql gs://ii_bq_scratch_dump/peeringdb-dump-$(date +%Y%m%d).sql
#+END_SRC

** Stand up local peeringdb with pre-prepared dump
Download from the bucket
#+BEGIN_SRC tmate :window peeringdb-sync
gsutil cp gs://ii_bq_scratch_dump/peeringdb-dump-20210512.sql ./peeringdb-dump-20210512.sql
#+END_SRC

Load the data from the dump into a new/separate Postgres instance
#+BEGIN_SRC tmate :window peeringdb-sync
psql -U postgres -d peeringdb -h $SHARINGIO_PAIR_LOAD_BALANCER_IP < ./peeringdb-dump-20210512.sql
#+END_SRC

** Explore
Connect with psql
#+BEGIN_SRC tmate :window peeringdb-sync
psql -U postgres -d peeringdb -h $SHARINGIO_PAIR_LOAD_BALANCER_IP
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id |         name         | asn | website
----+----------------------+-----+---------
 46 | XS4ALL Internet B.V. |     |
 17 | DALnet IRC Network   |     |
 90 | Plushosting B.V.     |     |
 91 | YellowBrix           |     |
 92 | NYCX                 |     |
(5 rows)

#+end_SRC

See the tables
#+BEGIN_SRC sql-mode :eval never-export :exports both :session none :sql-user postgres :sql-database peeringdb :sql-server (getenv "SHARINGIO_PAIR_LOAD_BALANCER_IP") :sql-password password
SELECT schemaname, tablename FROM pg_catalog.pg_tables WHERE schemaname != 'pg_catalog' AND schemaname != 'information_schema';
#+END_SRC

#+RESULTS:
#+begin_SRC example
 schemaname | tablename
------------+-----------
 peeringdb  | fac
 peeringdb  | ix
 peeringdb  | ixfac
 peeringdb  | ixlan
 peeringdb  | ixpfx
 peeringdb  | net
 peeringdb  | netfac
 peeringdb  | netixlan
 peeringdb  | org
 peeringdb  | poc
(10 rows)

#+end_SRC

Find data from peeringdb.org table
#+BEGIN_SRC sql-mode
select id, data::jsonb ->> 'name' as name, data::jsonb ->> 'asn' as asn, data::jsonb ->> 'website' as "website" from peeringdb.org where 'website' is not null limit 5;
#+END_SRC
#+BEGIN_SRC sql-mode
\d+
#+END_SRC

#+RESULTS:
#+begin_SRC example
                        List of relations
  Schema   |   Name   | Type  |  Owner   |  Size   | Description
-----------+----------+-------+----------+---------+-------------
 peeringdb | fac      | table | postgres | 3888 kB |
 peeringdb | ix       | table | postgres | 1288 kB |
 peeringdb | ixfac    | table | postgres | 960 kB  |
 peeringdb | ixlan    | table | postgres | 624 kB  |
 peeringdb | ixpfx    | table | postgres | 640 kB  |
 peeringdb | net      | table | postgres | 22 MB   |
 peeringdb | netfac   | table | postgres | 15 MB   |
 peeringdb | netixlan | table | postgres | 25 MB   |
 peeringdb | org      | table | postgres | 10 MB   |
 peeringdb | poc      | table | postgres | 3536 kB |
(10 rows)

#+end_SRC

#+BEGIN_SRC sql-mode
\d+ fac
#+END_SRC

#+RESULTS:
#+begin_SRC example
                                            Table "peeringdb.fac"
 Column  |           Type           | Collation | Nullable | Default | Storage  | Stats target | Description
---------+--------------------------+-----------+----------+---------+----------+--------------+-------------
 id      | integer                  |           | not null |         | plain    |              |
 org_id  | integer                  |           | not null |         | plain    |              |
 status  | text                     |           | not null |         | extended |              |
 data    | jsonb                    |           | not null |         | extended |              |
 created | timestamp with time zone |           | not null |         | plain    |              |
 updated | timestamp with time zone |           | not null |         | plain    |              |
 deleted | timestamp with time zone |           |          |         | plain    |              |
Indexes:
    "fac_pkey" PRIMARY KEY, btree (id)
Access method: heap

#+end_SRC

#+begin_src sql-mode
\d peeringdb.
#+end_src

#+RESULTS:
#+begin_SRC example
                        Table "peeringdb.fac"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 org_id  | integer                  |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "fac_pkey" PRIMARY KEY, btree (id)

      Index "peeringdb.fac_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.fac"

                        Table "peeringdb.ix"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 org_id  | integer                  |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "ix_pkey" PRIMARY KEY, btree (id)

      Index "peeringdb.ix_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.ix"

                       Table "peeringdb.ixfac"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 ix_id   | integer                  |           | not null |
 fac_id  | integer                  |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "ixfac_pkey" PRIMARY KEY, btree (id)

     Index "peeringdb.ixfac_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.ixfac"

                       Table "peeringdb.ixlan"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 ix_id   | integer                  |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "ixlan_pkey" PRIMARY KEY, btree (id)

     Index "peeringdb.ixlan_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.ixlan"

                       Table "peeringdb.ixpfx"
  Column  |           Type           | Collation | Nullable | Default
----------+--------------------------+-----------+----------+---------
 id       | integer                  |           | not null |
 ixlan_id | integer                  |           | not null |
 status   | text                     |           | not null |
 data     | jsonb                    |           | not null |
 created  | timestamp with time zone |           | not null |
 updated  | timestamp with time zone |           | not null |
 deleted  | timestamp with time zone |           |          |
Indexes:
    "ixpfx_pkey" PRIMARY KEY, btree (id)

     Index "peeringdb.ixpfx_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.ixpfx"

                        Table "peeringdb.net"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 org_id  | integer                  |           | not null |
 asn     | bigint                   |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "net_pkey" PRIMARY KEY, btree (id)

      Index "peeringdb.net_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.net"

                      Table "peeringdb.netfac"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 net_id  | integer                  |           | not null |
 fac_id  | integer                  |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "netfac_pkey" PRIMARY KEY, btree (id)

    Index "peeringdb.netfac_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.netfac"

                      Table "peeringdb.netixlan"
  Column  |           Type           | Collation | Nullable | Default
----------+--------------------------+-----------+----------+---------
 id       | integer                  |           | not null |
 net_id   | integer                  |           | not null |
 ix_id    | integer                  |           | not null |
 ixlan_id | integer                  |           | not null |
 status   | text                     |           | not null |
 data     | jsonb                    |           | not null |
 created  | timestamp with time zone |           | not null |
 updated  | timestamp with time zone |           | not null |
 deleted  | timestamp with time zone |           |          |
Indexes:
    "netixlan_pkey" PRIMARY KEY, btree (id)

   Index "peeringdb.netixlan_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.netixlan"

                        Table "peeringdb.org"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "org_pkey" PRIMARY KEY, btree (id)

      Index "peeringdb.org_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.org"

                        Table "peeringdb.poc"
 Column  |           Type           | Collation | Nullable | Default
---------+--------------------------+-----------+----------+---------
 id      | integer                  |           | not null |
 net_id  | integer                  |           | not null |
 status  | text                     |           | not null |
 data    | jsonb                    |           | not null |
 created | timestamp with time zone |           | not null |
 updated | timestamp with time zone |           | not null |
 deleted | timestamp with time zone |           |          |
Indexes:
    "poc_pkey" PRIMARY KEY, btree (id)

      Index "peeringdb.poc_pkey"
 Column |  Type   | Key? | Definition
--------+---------+------+------------
 id     | integer | yes  | id
primary key, btree, for table "peeringdb.poc"

#+end_SRC

Find data from peeringdb.net table
#+BEGIN_SRC sql-mode
select id, data::jsonb ->> 'name' as name, data::jsonb ->> 'asn' as asn, data::jsonb ->> 'website' as "website" from peeringdb.net limit 5;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id |         name         |  asn  |            website
----+----------------------+-------+--------------------------------
 83 | Cable&Wireless UK    | 5388  | http://www.cw.com/uk
 24 | DSLExtreme           | 19817 | http://www.dslextreme.com
 28 | New Edge Networks    | 19029 | http://www.newedgenetworks.com
 97 | Netservices Plc      | 15444 | http://www.netservicesplc.com
 36 | GrafiX Internet B.V. | 16131 | http://www.grafix.nl/
(5 rows)

#+end_SRC

Getting fields with emails
#+BEGIN_SRC sql-mode
select id, data::jsonb ->> 'name' as name, data::jsonb ->> 'email' as email, net_id from peeringdb.poc where status = 'ok' limit 5;
#+END_SRC

Connect ASNs with emails by joining names between tables
#+BEGIN_SRC sql-mode
select net.id,
       (net.data ->> 'name') as "name",
       (net.data ->> 'asn') as "asn",
       (net.data ->> 'website') as website,
       (poc.data ->> 'email') as email
       from peeringdb.net net
       left join peeringdb.poc on ((peeringdb.poc.data ->> 'name') = net.data ->> 'name')
       where (net.data ->>'website') is not null
       order by email asc
       limit 5;
#+END_SRC

#+BEGIN_SRC sql-mode
\d peeringdb.net
#+END_SRC
** schema exploration:
*** peeringdb.ixpfx -- has cidr, but only 2.5k
MAIN issue? this table only has 2500 rows, what we found in ip2asn is over 400k
#+BEGIN_SRC sql-mode
select * from peeringdb.ixpfx limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | ixlan_id | status  |                                                                                         data                                                                                          |        created         |        updated         |        deleted
----+----------+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+------------------------
  1 |        1 | deleted | {"id": 1, "in_dfz": true, "prefix": "206.223.115.0/24", "status": "deleted", "created": "2010-07-29T00:00:00Z", "updated": "2020-08-26T05:23:06Z", "ixlan_id": 1, "protocol": "IPv4"} | 2010-07-29 00:00:00+00 | 2020-08-26 05:23:06+00 | 2020-08-26 05:23:06+00
(1 row)

#+end_SRC



#+BEGIN_SRC sql-mode
select id, ixlan_id, status, data::jsonb ->> 'name' as name, data::jsonb ->> 'prefix' as prefix from peeringdb.ixpfx limit 5;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | ixlan_id | status  | name |      prefix
----+----------+---------+------+-------------------
  1 |        1 | deleted |      | 206.223.115.0/24
  2 |        1 | ok      |      | 2001:504:0:2::/64
  3 |        2 | ok      |      | 208.115.136.0/23
  4 |        2 | ok      |      | 2001:504:0:4::/64
  5 |        3 | ok      |      | 206.223.118.0/23
(5 rows)

#+end_SRC


#+BEGIN_SRC sql-mode
select count(data) from peeringdb.ixpfx;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 count
-------
  2275
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.ixpfx limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
              jsonb_pretty
----------------------------------------
 {                                     +
     "id": 1,                          +
     "in_dfz": true,                   +
     "prefix": "206.223.115.0/24",     +
     "status": "deleted",              +
     "created": "2010-07-29T00:00:00Z",+
     "updated": "2020-08-26T05:23:06Z",+
     "ixlan_id": 1,                    +
     "protocol": "IPv4"                +
 }
 {                                     +
     "id": 2,                          +
     "in_dfz": true,                   +
     "prefix": "2001:504:0:2::/64",    +
     "status": "ok",                   +
     "created": "2010-07-29T00:00:00Z",+
     "updated": "2020-08-26T05:23:08Z",+
     "ixlan_id": 1,                    +
     "protocol": "IPv6"                +
 }
(2 rows)

#+end_SRC

*** peeringdb.fac

#+BEGIN_SRC sql-mode
select * from peeringdb.fac limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
----+--------+---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+------------------------
  3 |      7 | deleted | {"id": 3, "aka": "", "city": "New York", "clli": "NYCMNY", "name": "Telehouse New York Broadway", "floor": "", "notes": "", "state": "NY", "suite": "", "npanxx": "212-785", "org_id": 7, "status": "deleted", "country": "US", "created": "2010-07-29T00:00:00Z", "rencode": "", "updated": "2016-11-01T04:16:24Z", "website": "http://www.telehouse.net", "zipcode": "10004-1010", "address1": "25 Broadway", "address2": "", "latitude": null, "org_name": "Telehouse - Global Data Centers", "longitude": null, "name_long": "", "net_count": 0, "tech_email": "", "tech_phone": "", "sales_email": "", "sales_phone": ""} | 2010-07-29 00:00:00+00 | 2016-11-01 04:16:24+00 | 2016-11-01 04:16:24+00
(1 row)

#+end_SRC
No sign of ip ranges, gonna try the next one

#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.fac limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
                    jsonb_pretty
-----------------------------------------------------
 {                                                  +
     "id": 3,                                       +
     "aka": "",                                     +
     "city": "New York",                            +
     "clli": "NYCMNY",                              +
     "name": "Telehouse New York Broadway",         +
     "floor": "",                                   +
     "notes": "",                                   +
     "state": "NY",                                 +
     "suite": "",                                   +
     "npanxx": "212-785",                           +
     "org_id": 7,                                   +
     "status": "deleted",                           +
     "country": "US",                               +
     "created": "2010-07-29T00:00:00Z",             +
     "rencode": "",                                 +
     "updated": "2016-11-01T04:16:24Z",             +
     "website": "http://www.telehouse.net",         +
     "zipcode": "10004-1010",                       +
     "address1": "25 Broadway",                     +
     "address2": "",                                +
     "latitude": null,                              +
     "org_name": "Telehouse - Global Data Centers", +
     "longitude": null,                             +
     "name_long": "",                               +
     "net_count": 0,                                +
     "tech_email": "",                              +
     "tech_phone": "",                              +
     "sales_email": "",                             +
     "sales_phone": ""                              +
 }
 {                                                  +
     "id": 42,                                      +
     "aka": "",                                     +
     "city": "London",                              +
     "clli": "LONDEN",                              +
     "name": "Equinix London Docklands_ (LD8)",     +
     "floor": "",                                   +
     "notes": "",                                   +
     "state": "",                                   +
     "suite": "",                                   +
     "npanxx": "",                                  +
     "org_id": 2,                                   +
     "status": "deleted",                           +
     "country": "GB",                               +
     "created": "2010-07-29T00:00:00Z",             +
     "rencode": "",                                 +
     "updated": "2017-01-22T17:23:59Z",             +
     "website": "http://www.equinix.com/locations/",+
     "zipcode": "E14 9GE",                          +
     "address1": "6-9 Harbour Exchange Square",     +
     "address2": "",                                +
     "latitude": null,                              +
     "org_name": "Equinix, Inc.",                   +
     "longitude": null,                             +
     "name_long": "",                               +
     "net_count": 0,                                +
     "tech_email": "",                              +
     "tech_phone": "",                              +
     "sales_email": "",                             +
     "sales_phone": ""                              +
 }
(2 rows)

#+end_SRC

*** peeringdb.ix
#+BEGIN_SRC sql-mode
select * from peeringdb.ix limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | org_id | status  |                                                                                                                                                                                                                                                                                           data                                                                                                                                                                                                                                                                                            |        created         |        updated         |        deleted
----+--------+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+------------------------
 36 |     85 | deleted | {"id": 36, "aka": "", "city": "Paris", "name": "FreeIX", "media": "Ethernet", "notes": "", "org_id": 85, "status": "deleted", "country": "FR", "created": "2010-07-29T00:00:00Z", "updated": "2016-03-14T20:42:55Z", "website": "http://www.freeix.net/", "name_long": "Free Internet eXchange", "net_count": 0, "url_stats": "http://www.freeix.net/mrtg/", "proto_ipv6": false, "tech_email": "", "tech_phone": "", "policy_email": "", "policy_phone": "", "ixf_net_count": 0, "proto_unicast": true, "ixf_last_import": null, "proto_multicast": false, "region_continent": "Europe"} | 2010-07-29 00:00:00+00 | 2016-03-14 20:42:55+00 | 2016-03-14 20:42:55+00
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.ix limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
                     jsonb_pretty
------------------------------------------------------
 {                                                   +
     "id": 36,                                       +
     "aka": "",                                      +
     "city": "Paris",                                +
     "name": "FreeIX",                               +
     "media": "Ethernet",                            +
     "notes": "",                                    +
     "org_id": 85,                                   +
     "status": "deleted",                            +
     "country": "FR",                                +
     "created": "2010-07-29T00:00:00Z",              +
     "updated": "2016-03-14T20:42:55Z",              +
     "website": "http://www.freeix.net/",            +
     "name_long": "Free Internet eXchange",          +
     "net_count": 0,                                 +
     "url_stats": "http://www.freeix.net/mrtg/",     +
     "proto_ipv6": false,                            +
     "tech_email": "",                               +
     "tech_phone": "",                               +
     "policy_email": "",                             +
     "policy_phone": "",                             +
     "ixf_net_count": 0,                             +
     "proto_unicast": true,                          +
     "ixf_last_import": null,                        +
     "proto_multicast": false,                       +
     "region_continent": "Europe"                    +
 }
 {                                                   +
     "id": 19,                                       +
     "aka": "",                                      +
     "city": "Chicago",                              +
     "name": "AADS",                                 +
     "media": "ATM",                                 +
     "notes": "",                                    +
     "org_id": 48,                                   +
     "status": "deleted",                            +
     "country": "US",                                +
     "created": "2010-07-29T00:00:00Z",              +
     "updated": "2016-03-14T21:08:05Z",              +
     "website": "",                                  +
     "name_long": "Ameritech Advanced Data Services",+
     "net_count": 0,                                 +
     "url_stats": "",                                +
     "proto_ipv6": false,                            +
     "tech_email": "",                               +
     "tech_phone": "",                               +
     "policy_email": "",                             +
     "policy_phone": "",                             +
     "ixf_net_count": 0,                             +
     "proto_unicast": true,                          +
     "ixf_last_import": null,                        +
     "proto_multicast": false,                       +
     "region_continent": "North America"             +
 }
(2 rows)

#+end_SRC

*** peeringdb.ixfac

#+BEGIN_SRC sql-mode
select * from peeringdb.ixfac limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | ix_id | fac_id | status |                                                             data                                                             |        created         |        updated         | deleted
----+-------+--------+--------+------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+---------
 72 |    48 |    164 | ok     | {"id": 72, "ix_id": 48, "fac_id": 164, "status": "ok", "created": "2010-07-29T00:00:00Z", "updated": "2016-03-11T07:21:43Z"} | 2010-07-29 00:00:00+00 | 2016-03-11 07:21:43+00 |
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.ixfac limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
              jsonb_pretty
----------------------------------------
 {                                     +
     "id": 72,                         +
     "ix_id": 48,                      +
     "fac_id": 164,                    +
     "status": "ok",                   +
     "created": "2010-07-29T00:00:00Z",+
     "updated": "2016-03-11T07:21:43Z" +
 }
 {                                     +
     "id": 73,                         +
     "ix_id": 48,                      +
     "fac_id": 177,                    +
     "status": "ok",                   +
     "created": "2010-07-29T00:00:00Z",+
     "updated": "2016-03-11T07:21:43Z" +
 }
(2 rows)

#+end_SRC

*** peeringdb.ixlan

#+BEGIN_SRC sql-mode
select * from peeringdb.ixlan limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | ix_id | status |                                                                                                                            data                                                                                                                            |        created         |        updated         | deleted
----+-------+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+---------
 41 |    41 | ok     | {"id": 41, "mtu": null, "name": "", "descr": "", "ix_id": 41, "rs_asn": 0, "status": "ok", "created": "2010-07-29T00:00:00Z", "updated": "2016-03-11T07:21:58Z", "arp_sponge": null, "dot1q_support": false, "ixf_ixp_member_list_url_visible": "Private"} | 2010-07-29 00:00:00+00 | 2016-03-11 07:21:58+00 |
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.ixlan limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
                   jsonb_pretty
--------------------------------------------------
 {                                               +
     "id": 41,                                   +
     "mtu": null,                                +
     "name": "",                                 +
     "descr": "",                                +
     "ix_id": 41,                                +
     "rs_asn": 0,                                +
     "status": "ok",                             +
     "created": "2010-07-29T00:00:00Z",          +
     "updated": "2016-03-11T07:21:58Z",          +
     "arp_sponge": null,                         +
     "dot1q_support": false,                     +
     "ixf_ixp_member_list_url_visible": "Private"+
 }
 {                                               +
     "id": 43,                                   +
     "mtu": null,                                +
     "name": "",                                 +
     "descr": "",                                +
     "ix_id": 43,                                +
     "rs_asn": 0,                                +
     "status": "ok",                             +
     "created": "2010-07-29T00:00:00Z",          +
     "updated": "2016-03-11T07:21:58Z",          +
     "arp_sponge": null,                         +
     "dot1q_support": false,                     +
     "ixf_ixp_member_list_url_visible": "Private"+
 }
(2 rows)

#+end_SRC

*** peeringdb.ixpfx

#+BEGIN_SRC sql-mode
select * from peeringdb.ixpfx limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | ixlan_id | status  |                                                                                         data                                                                                          |        created         |        updated         |        deleted
----+----------+---------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+------------------------
  1 |        1 | deleted | {"id": 1, "in_dfz": true, "prefix": "206.223.115.0/24", "status": "deleted", "created": "2010-07-29T00:00:00Z", "updated": "2020-08-26T05:23:06Z", "ixlan_id": 1, "protocol": "IPv4"} | 2010-07-29 00:00:00+00 | 2020-08-26 05:23:06+00 | 2020-08-26 05:23:06+00
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.ixpfx limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
              jsonb_pretty
----------------------------------------
 {                                     +
     "id": 1,                          +
     "in_dfz": true,                   +
     "prefix": "206.223.115.0/24",     +
     "status": "deleted",              +
     "created": "2010-07-29T00:00:00Z",+
     "updated": "2020-08-26T05:23:06Z",+
     "ixlan_id": 1,                    +
     "protocol": "IPv4"                +
 }
 {                                     +
     "id": 2,                          +
     "in_dfz": true,                   +
     "prefix": "2001:504:0:2::/64",    +
     "status": "ok",                   +
     "created": "2010-07-29T00:00:00Z",+
     "updated": "2020-08-26T05:23:08Z",+
     "ixlan_id": 1,                    +
     "protocol": "IPv6"                +
 }
(2 rows)

#+end_SRC

*** peeringdb.net

#+BEGIN_SRC sql-mode
select * from peeringdb.net limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | org_id | asn  | status |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  data                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |        created         |        updated         | deleted
----+--------+------+--------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+---------
 83 |   3152 | 5388 | ok     | {"id": 83, "aka": "", "asn": 5388, "name": "Cable&Wireless UK", "notes": "This is former Energis Communications UK backbone network (AS5388) which is now owned by Cable and Wireless.\r\n\r\nAS5388 have no direct peering relations any longer, for peering request please contact our backbone AS1273 peering team.\r\n\r\nCable and Wireless global backbone network (AS1273) has a separate PeeringDB entry.\r\n", "org_id": 3152, "status": "ok", "created": "2004-08-03T10:30:54Z", "updated": "2016-03-14T20:23:33Z", "website": "http://www.cw.com/uk", "info_ipv6": false, "info_type": "NSP", "name_long": "", "info_ratio": "Balanced", "info_scope": "Regional", "irr_as_set": "AS-ENERGIS", "policy_url": "", "poc_updated": "2020-01-22T04:24:08Z", "info_traffic": "10-20Gbps", "info_unicast": true, "policy_ratio": false, "route_server": "", "looking_glass": "http://as5388.net/cgi-bin/lg.pl", "info_multicast": false, "info_prefixes4": 30, "info_prefixes6": 2, "netfac_updated": "2016-03-14T21:24:34Z", "policy_general": "Restrictive", "allow_ixp_update": false, "netixlan_updated": null, "policy_contracts": "Not Required", "policy_locations": "Not Required", "info_never_via_route_servers": false} | 2004-08-03 10:30:54+00 | 2016-03-14 20:23:33+00 |
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select id, org_id, status, data::jsonb ->> 'asn' as asn, data::jsonb ->> 'name' as name, data::jsonb ->> 'website' as website from peeringdb.net limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | org_id | status | asn  |       name        |       website
----+--------+--------+------+-------------------+----------------------
 83 |   3152 | ok     | 5388 | Cable&Wireless UK | http://www.cw.com/uk
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select count(data::jsonb ->> 'asn') from peeringdb.net limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 count
-------
 23095
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.net limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
                                                                                                                                                                        jsonb_pretty
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {                                                                                                                                                                                                                                                                                                                                                          +
     "id": 83,                                                                                                                                                                                                                                                                                                                                              +
     "aka": "",                                                                                                                                                                                                                                                                                                                                             +
     "asn": 5388,                                                                                                                                                                                                                                                                                                                                           +
     "name": "Cable&Wireless UK",                                                                                                                                                                                                                                                                                                                           +
     "notes": "This is former Energis Communications UK backbone network (AS5388) which is now owned by Cable and Wireless.\r\n\r\nAS5388 have no direct peering relations any longer, for peering request please contact our backbone AS1273 peering team.\r\n\r\nCable and Wireless global backbone network (AS1273) has a separate PeeringDB entry.\r\n",+
     "org_id": 3152,                                                                                                                                                                                                                                                                                                                                        +
     "status": "ok",                                                                                                                                                                                                                                                                                                                                        +
     "created": "2004-08-03T10:30:54Z",                                                                                                                                                                                                                                                                                                                     +
     "updated": "2016-03-14T20:23:33Z",                                                                                                                                                                                                                                                                                                                     +
     "website": "http://www.cw.com/uk",                                                                                                                                                                                                                                                                                                                     +
     "info_ipv6": false,                                                                                                                                                                                                                                                                                                                                    +
     "info_type": "NSP",                                                                                                                                                                                                                                                                                                                                    +
     "name_long": "",                                                                                                                                                                                                                                                                                                                                       +
     "info_ratio": "Balanced",                                                                                                                                                                                                                                                                                                                              +
     "info_scope": "Regional",                                                                                                                                                                                                                                                                                                                              +
     "irr_as_set": "AS-ENERGIS",                                                                                                                                                                                                                                                                                                                            +
     "policy_url": "",                                                                                                                                                                                                                                                                                                                                      +
     "poc_updated": "2020-01-22T04:24:08Z",                                                                                                                                                                                                                                                                                                                 +
     "info_traffic": "10-20Gbps",                                                                                                                                                                                                                                                                                                                           +
     "info_unicast": true,                                                                                                                                                                                                                                                                                                                                  +
     "policy_ratio": false,                                                                                                                                                                                                                                                                                                                                 +
     "route_server": "",                                                                                                                                                                                                                                                                                                                                    +
     "looking_glass": "http://as5388.net/cgi-bin/lg.pl",                                                                                                                                                                                                                                                                                                    +
     "info_multicast": false,                                                                                                                                                                                                                                                                                                                               +
     "info_prefixes4": 30,                                                                                                                                                                                                                                                                                                                                  +
     "info_prefixes6": 2,                                                                                                                                                                                                                                                                                                                                   +
     "netfac_updated": "2016-03-14T21:24:34Z",                                                                                                                                                                                                                                                                                                              +
     "policy_general": "Restrictive",                                                                                                                                                                                                                                                                                                                       +
     "allow_ixp_update": false,                                                                                                                                                                                                                                                                                                                             +
     "netixlan_updated": null,                                                                                                                                                                                                                                                                                                                              +
     "policy_contracts": "Not Required",                                                                                                                                                                                                                                                                                                                    +
     "policy_locations": "Not Required",                                                                                                                                                                                                                                                                                                                    +
     "info_never_via_route_servers": false                                                                                                                                                                                                                                                                                                                  +
 }
 {                                                                                                                                                                                                                                                                                                                                                          +
     "id": 24,                                                                                                                                                                                                                                                                                                                                              +
     "aka": "Extreme Telecom",                                                                                                                                                                                                                                                                                                                              +
     "asn": 19817,                                                                                                                                                                                                                                                                                                                                          +
     "name": "DSLExtreme",                                                                                                                                                                                                                                                                                                                                  +
     "notes": "",                                                                                                                                                                                                                                                                                                                                           +
     "org_id": 62,                                                                                                                                                                                                                                                                                                                                          +
     "status": "ok",                                                                                                                                                                                                                                                                                                                                        +
     "created": "2004-07-28T00:00:00Z",                                                                                                                                                                                                                                                                                                                     +
     "updated": "2016-03-14T20:47:30Z",                                                                                                                                                                                                                                                                                                                     +
     "website": "http://www.dslextreme.com",                                                                                                                                                                                                                                                                                                                +
     "info_ipv6": false,                                                                                                                                                                                                                                                                                                                                    +
     "info_type": "Cable/DSL/ISP",                                                                                                                                                                                                                                                                                                                          +
     "name_long": "",                                                                                                                                                                                                                                                                                                                                       +
     "info_ratio": "Mostly Inbound",                                                                                                                                                                                                                                                                                                                        +
     "info_scope": "Regional",                                                                                                                                                                                                                                                                                                                              +
     "irr_as_set": "",                                                                                                                                                                                                                                                                                                                                      +
     "policy_url": "",                                                                                                                                                                                                                                                                                                                                      +
     "poc_updated": "2016-03-14T21:35:12Z",                                                                                                                                                                                                                                                                                                                 +
     "info_traffic": "1-5Gbps",                                                                                                                                                                                                                                                                                                                             +
     "info_unicast": true,                                                                                                                                                                                                                                                                                                                                  +
     "policy_ratio": false,                                                                                                                                                                                                                                                                                                                                 +
     "route_server": "",                                                                                                                                                                                                                                                                                                                                    +
     "looking_glass": "",                                                                                                                                                                                                                                                                                                                                   +
     "info_multicast": false,                                                                                                                                                                                                                                                                                                                               +
     "info_prefixes4": 69,                                                                                                                                                                                                                                                                                                                                  +
     "info_prefixes6": 3,                                                                                                                                                                                                                                                                                                                                   +
     "netfac_updated": "2016-03-14T20:33:54Z",                                                                                                                                                                                                                                                                                                              +
     "policy_general": "Open",                                                                                                                                                                                                                                                                                                                              +
     "allow_ixp_update": false,                                                                                                                                                                                                                                                                                                                             +
     "netixlan_updated": "2021-05-12T00:13:00.764215Z",                                                                                                                                                                                                                                                                                                     +
     "policy_contracts": "Not Required",                                                                                                                                                                                                                                                                                                                    +
     "policy_locations": "Not Required",                                                                                                                                                                                                                                                                                                                    +
     "info_never_via_route_servers": false                                                                                                                                                                                                                                                                                                                  +
 }
(2 rows)

#+end_SRC

*** peeringdb.netixlan

#+BEGIN_SRC sql-mode
select * from peeringdb.netixlan limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | net_id | ix_id | ixlan_id | status |                                                                                                                                                 data                                                                                                                                                 |        created         |        updated         | deleted
----+--------+-------+----------+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+---------
 81 |      3 |    64 |       64 | ok     | {"id": 81, "asn": 31800, "name": "NL-ix: Main", "ix_id": 64, "notes": "", "speed": 1000, "net_id": 3, "status": "ok", "created": "2010-07-29T00:00:00Z", "ipaddr4": "193.239.116.162", "ipaddr6": null, "updated": "2016-03-14T21:02:11Z", "ixlan_id": 64, "is_rs_peer": false, "operational": true} | 2010-07-29 00:00:00+00 | 2016-03-14 21:02:11+00 |
(1 row)
#+end_SRC
#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.netixlan limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
              jsonb_pretty
----------------------------------------
 {                                     +
     "id": 81,                         +
     "asn": 31800,                     +
     "name": "NL-ix: Main",            +
     "ix_id": 64,                      +
     "notes": "",                      +
     "speed": 1000,                    +
     "net_id": 3,                      +
     "status": "ok",                   +
     "created": "2010-07-29T00:00:00Z",+
     "ipaddr4": "193.239.116.162",     +
     "ipaddr6": null,                  +
     "updated": "2016-03-14T21:02:11Z",+
     "ixlan_id": 64,                   +
     "is_rs_peer": false,              +
     "operational": true               +
 }
 {                                     +
     "id": 84,                         +
     "asn": 31800,                     +
     "name": "Equinix Dallas",         +
     "ix_id": 3,                       +
     "notes": "",                      +
     "speed": 1000,                    +
     "net_id": 3,                      +
     "status": "ok",                   +
     "created": "2010-07-29T00:00:00Z",+
     "ipaddr4": "206.223.118.88",      +
     "ipaddr6": null,                  +
     "updated": "2016-03-14T21:02:11Z",+
     "ixlan_id": 3,                    +
     "is_rs_peer": false,              +
     "operational": true               +
 }
(2 rows)

#+end_SRC

#+BEGIN_SRC sql-mode
select count(data) from peeringdb.netixlan limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 count
-------
 55319
(1 row)

#+end_SRC

*** peeringdb.org

#+BEGIN_SRC sql-mode
select * from peeringdb.org limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | status |                                                                                                                                                                      data                                                                                                                                                                      |        created         |        updated         | deleted
----+--------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+---------
 46 | ok     | {"id": 46, "aka": "", "city": "", "name": "XS4ALL Internet B.V.", "floor": "", "notes": "", "state": "", "suite": "", "status": "ok", "country": "", "created": "2004-07-28T00:00:00Z", "updated": "2016-03-14T20:23:26Z", "website": "", "zipcode": "", "address1": "", "address2": "", "latitude": null, "longitude": null, "name_long": ""} | 2004-07-28 00:00:00+00 | 2016-03-14 20:23:26+00 |
(1 row)

#+end_SRC
#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.org limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
              jsonb_pretty
----------------------------------------
 {                                     +
     "id": 46,                         +
     "aka": "",                        +
     "city": "",                       +
     "name": "XS4ALL Internet B.V.",   +
     "floor": "",                      +
     "notes": "",                      +
     "state": "",                      +
     "suite": "",                      +
     "status": "ok",                   +
     "country": "",                    +
     "created": "2004-07-28T00:00:00Z",+
     "updated": "2016-03-14T20:23:26Z",+
     "website": "",                    +
     "zipcode": "",                    +
     "address1": "",                   +
     "address2": "",                   +
     "latitude": null,                 +
     "longitude": null,                +
     "name_long": ""                   +
 }
 {                                     +
     "id": 17,                         +
     "aka": "",                        +
     "city": "",                       +
     "name": "DALnet IRC Network",     +
     "floor": "",                      +
     "notes": "",                      +
     "state": "",                      +
     "suite": "",                      +
     "status": "ok",                   +
     "country": "",                    +
     "created": "2004-07-28T00:00:00Z",+
     "updated": "2016-03-14T20:27:47Z",+
     "website": "",                    +
     "zipcode": "",                    +
     "address1": "",                   +
     "address2": "",                   +
     "latitude": null,                 +
     "longitude": null,                +
     "name_long": ""                   +
 }
(2 rows)

#+end_SRC

*** peeringdb.poc
#+BEGIN_SRC sql-mode
select * from peeringdb.poc limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id  | net_id | status |                                                                                                                            data                                                                                                                             |        created         |        updated         | deleted
-----+--------+--------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------+------------------------+---------
 100 |    115 | ok     | {"id": 100, "url": "", "name": "Telefonica DE Peering Team", "role": "Policy", "email": "peering.de@telefonica.com", "phone": "", "net_id": 115, "status": "ok", "created": "2010-07-29T00:00:00Z", "updated": "2016-05-20T13:55:47Z", "visible": "Public"} | 2010-07-29 00:00:00+00 | 2016-05-20 13:55:47+00 |
(1 row)

#+end_SRC


#+BEGIN_SRC sql-mode
select jsonb_pretty(data) from peeringdb.poc limit 2;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 {                                        +
     "id": 100,                           +
     "url": "",                           +
     "name": "Telefonica DE Peering Team",+
     "role": "Policy",                    +
     "email": "peering.de@telefonica.com",+
     "phone": "",                         +
     "net_id": 115,                       +
     "status": "ok",                      +
     "created": "2010-07-29T00:00:00Z",   +
     "updated": "2016-05-20T13:55:47Z",   +
     "visible": "Public"                  +
 }
 {                                        +
     "id": 48,                            +
     "url": "",                           +
     "name": "NOC",                       +
     "role": "NOC",                       +
     "email": "noc@stealth.net",          +
     "phone": "+12122322020",             +
     "net_id": 26,                        +
     "status": "ok",                      +
     "created": "2010-07-29T00:00:00Z",   +
     "updated": "2020-05-20T23:14:22Z",   +
     "visible": "Public"                  +
 }

#+end_SRC

** Post process org blocks
Just making sure we can get to json
#+NAME: json-res
#+BEGIN_SRC sql-mode :var json-r=""
select data from peeringdb.ixlan limit 1;
#+END_SRC

#+RESULTS: json-res
#+begin_SRC example
 {"id": 41, "mtu": null, "name": "", "descr": "", "ix_id": 41, "rs_asn": 0, "status": "ok", "created": "2010-07-29T00:00:00Z", "updated": "2016-03-11T07:21:58Z", "arp_sponge": null, "dot1q_support": false, "ixf_ixp_member_list_url_visible": "Private"}

#+end_SRC

Dang it I am missing something here....
#+BEGIN_SRC shell :process_r yes :post json-res[:process_r yes](*this*)
jq '.'
#+END_SRC

#+RESULTS:
#+begin_example
 {"id": 41, "mtu": null, "name": "", "descr": "", "ix_id": 41, "rs_asn": 0, "status": "ok", "created": "2010-07-29T00:00:00Z", "updated": "2016-03-11T07:21:58Z", "arp_sponge": null, "dot1q_support": false, "ixf_ixp_member_list_url_visible": "Private"}
#+end_example

** Wrap header for json.
#+BEGIN_SRC sql-mode :results sql :wrap EXPORT json
select data from peeringdb.ixlan limit 1;
#+END_SRC

#+RESULTS:
#+begin_EXPORT json
 {"id": 41, "mtu": null, "name": "", "descr": "", "ix_id": 41, "rs_asn": 0, "status": "ok", "created": "2010-07-29T00:00:00Z", "updated": "2016-03-11T07:21:58Z", "arp_sponge": null, "dot1q_support": false, "ixf_ixp_member_list_url_visible": "Private"}

#+end_EXPORT

** Building asn-ip list with Postgres (this requires import of a asn list)
#+BEGIN_SRC sql-mode
create schema asntocompany;
#+END_SRC

#+RESULTS:
#+begin_SRC example
CREATE SCHEMA
#+end_SRC
Split asn from dump so we have table with ony asns, will name that one `asnproc`
#+BEGIN_SRC tmate :window autonums :dir (concat (getenv "HOME") "/autonums")
cat /home/ii/autonums/asn_company_results.csv | cut -d ',' -f1 | sed 's/"//' | sed 's/"//'| cut -d 'S' -f2 >> asns_only.txt
#+END_SRC

#+BEGIN_SRC sql-mode
-- create table asnproc (
--       asn bigint not null primary key
-- );
\copy asnproc from '/home/ii/autonums/asns_only.txt';
#+END_SRC

#+RESULTS:
#+begin_SRC example
#+end_SRC
** Trying a few queries to see what I see
#+BEGIN_SRC sql-mode
select (net.data ->> 'name') as "name",
       asn
    from peeringdb.net
    where (net.data ->> 'name') ilike '%google%'
    limit 5;
#+END_SRC

#+RESULTS:
#+begin_SRC example
        name        |  asn
--------------------+-------
 Google LLC         | 15169
 Google LLC AS19527 | 19527
 Google LLC AS36040 | 36040
 Google LLC AS43515 | 43515
 Google Fiber, Inc. | 16591
(5 rows)

#+end_SRC

We only have 23k asns
#+BEGIN_SRC sql-mode
select count(*)
    from peeringdb.net
    where (net.data ->> 'asn') is not null;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 count
-------
 23097
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select count(*)
from peeringdb.poc p
where (p.data ->> 'email') is not null;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 count
-------
 10756
(1 row)

#+end_SRC


#+BEGIN_SRC sql-mode
select
       (poc.data ->> 'name') as poc_name
from peeringdb.poc poc
-- left join peeringdb.poc poc on ((net.data ->>'name') = (poc.data ->>'name'))
where (poc.data ->> 'name') ilike '%google%'
or (poc.data ->> 'name') ilike '%amazon%'
or (poc.data ->> 'name') ilike '%microsoft%';
-- where (net.data ->>'name') ilike '%google%';
-- select data from peeringdb.net where (data ->> 'asn')::bigint = 21789 limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
             poc_name
-----------------------------------
 noc@google.com
 Google Fiber NOC
 Diretoria de Tecnologia Amazontel
 Diretoria de Tecnologia Amazontel
 Ganesh Wakode Google Mail
(5 rows)

#+end_SRC

#+BEGIN_SRC sql-mode
begin;
-- create table asnproc (
--        asn bigint not null primary key
-- );
-- \copy asnproc from '/home/ii/peeringdb-simplesync/asns.txt';
select count(*) from peeringdb.poc;
select net.id,
       asnproc.asn,
       (net.data ->> 'name') as "name",
       (net.data ->> 'website') as "website"
       -- (poc.data ->> 'email') as email
       from asnproc
       join peeringdb.net net on ((net.data ->> 'asn')::bigint = asnproc.asn)
       -- left join peeringdb.poc poc on ((poc.data ->> 'name') = 'chonkers')
       -- left join peeringdb.poc poc on ((poc.data ->> 'name') = (net.data ->> 'name'))
       -- where (net.data ->>'website') is not null
       -- order by email asc
       limit 5;
rollback;
#+END_SRC

#+RESULTS:
#+begin_SRC example
BEGIN
 count
-------
 34255
(1 row)

#+end_SRC

* Metadata from peeringdb
It looks like this is the best info I can get from this database
There are not that many entries in this database, I am not super impressed with the info, it will probably end up being more supplimental for shadow and pyasn
Problem, I need to confirm that I can get better metadata from shadowserver
Use this when we create the metadata tables
###### This is the best I can find for asn, name, website, email###########
#+BEGIN_SRC sql-mode
select asn.asn,
       (net.data ->> 'name') as "name",
       (net.data ->> 'website') as "website",
       (poc.data ->> 'email') as email
       from asnproc asn
       left join peeringdb.net net on (net.asn = asn.asn)
       left join peeringdb.poc poc on ((poc.data ->> 'name') = (net.data ->> 'name'))
       -- where (net.data ->>'website') is not null
       -- where (poc.data ->> 'email') is not null
       order by email asc limit 10;
#+END_SRC

#+RESULTS:
#+begin_SRC example
  asn   |          name          |             website              |             email
--------+------------------------+----------------------------------+-------------------------------
 268729 | Wnett Fibra            | http://www.wnettfibra.com.br     |
 131916 | BAYNET                 | http://www.baynet.ne.jp/         | BAYNET-peer@tokyobaynet.co.jp
 206161 | Nils Steinger          | https://voidptr.de               | NST24-RIPE@voidptr.de
 206161 | Nils Steinger          | https://voidptr.de               | RIPE-abuse@voidptr.de
  53113 | AGYONET                | http://WWW.AGYONET.COM.BR        | SUPORTEADM@AGYONET.COM.BR
 269501 | OneTech Telecom        | http://www.onetechtelecom.com.br | abuse2@onetechtelecom.com.br
 213261 | Sebastian-Wilhelm Graf | http://sebastian-graf.at         | abuse@AS213261.net
 213126 | Andreas Fries          |                                  | abuse@afries.ch
 196865 | Aircomm S.r.l.         | http://www.aircomm.it            | abuse@aircomm.it
 208266 | Hanqi Yang             | https://network.alanyhq.com/     | abuse@alanyhq-global.net
(10 rows)

#+end_SRC


#+RESULTS:



#+BEGIN_SRC sql-mode
select id, org_id, status, data::jsonb ->> 'asn' as asn, data::jsonb ->> 'name' as name, data::jsonb ->> 'website' as website from peeringdb.net limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 id | org_id | status | asn  |       name        |       website
----+--------+--------+------+-------------------+----------------------
 83 |   3152 | ok     | 5388 | Cable&Wireless UK | http://www.cw.com/uk
(1 row)

#+end_SRC

#+BEGIN_SRC sql-mode
select count(data) from peeringdb.net limit 1;
#+END_SRC

#+RESULTS:
#+begin_SRC example
 count
-------
 23095
(1 row)

#+end_SRC

* shadowserver
